app-id: com.hunterwittenborn.Celeste
runtime: org.gnome.Platform
runtime-version: '48'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-nightly
  - org.freedesktop.Sdk.Extension.llvm19
  - org.freedesktop.Sdk.Extension.golang
build-options:
  append-path: /usr/lib/sdk/rust-nightly/bin:/usr/lib/sdk/llvm19/bin
  env:
    CARGO_HOME: /run/build/celeste/cargo
command: celeste
finish-args:
  # We need to display on Wayland/X11.
  - '--socket=wayland'
  - '--socket=fallback-x11'
  # Enable OpenGL rendering.
  - '--device=dri'
  # Users may want to sync files from anywhere on their system.
  - '--filesystem=host'
  # We need network access in order to sync files to remotes.
  - '--share=network'
  # Used for X11 performance as described at
  # https://docs.flatpak.org/en/latest/sandbox-permissions-reference.html#f1.
  - '--share=ipc'
  # DBus sockets we need for tray access. Taken from https://github.com/flathub/com.discordapp.Discord/blob/a4b3f6e47f61f0ddb2537181812e1696f58b4eba/com.discordapp.Discord.json#L24-L28.
  - '--talk-name=org.kde.StatusNotifierWatcher'
  - '--talk-name=com.canonical.AppMenu.Registrar'
  - '--talk-name=com.canonical.indicator.application'
  - '--talk-name=com.canonical.Unity.LauncherEntry'
  - '--own-name=org.kde.*'
  # Extra libraries that we've bundled with the Flatpak in order to run.
  # '/usr/lib/x86_64-linux-gnu' is exposed by default, but if we specify
  # one we have to specify them all.
  - '--env=LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:/app/lib/x86_64-linux-gnu'
modules:
  - name: celeste
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/rust-nightly/bin:/usr/lib/sdk/golang/bin
    build-commands:
      - cargo --offline fetch --manifest-path Cargo.toml --verbose
      - cargo --offline build --release
      - install -Dm 755 target/release/celeste /app/bin/celeste
    post-install:
      - install -Dm644 assets/com.hunterwittenborn.Celeste-regular.svg /app/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg
      - install -Dm644 assets/${FLATPAK_ID}.metainfo.xml /app/share/metainfo/${FLATPAK_ID}.metainfo.xml
      - install -Dm644 assets/${FLATPAK_ID}.desktop /app/share/applications/${FLATPAK_ID}.desktop
    sources:
      - type: git
        url: https://github.com/hwittenborn/celeste
        tag: v0.8.3
      - cargo-sources.json
      - go-sources.yml
